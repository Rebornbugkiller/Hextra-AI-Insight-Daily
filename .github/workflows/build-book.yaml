name: Update Content from Daily Notes
on:
  workflow_dispatch:
    inputs:
      source_repo:
        description: 'è¦æ‹‰å–ä»£ç çš„æºä»“åº“ (æ ¼å¼: owner/repo)'
        required: true
        default: 'Rebornbugkiller/Hextra-AI-Insight-Daily'
      source_branch:
        description: 'è¦æ‹‰å–çš„æºåˆ†æ”¯'
        required: true
        default: 'main'

  schedule:
    - cron: '0 22 * * *'

jobs:
  build-and-commit:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout current repository
        uses: actions/checkout@v4

      - name: Clone source repository
        uses: actions/checkout@v4
        with:
          repository: ${{ github.event.inputs.source_repo || 'Rebornbugkiller/Hextra-AI-Insight-Daily' }}
          ref: ${{ github.event.inputs.source_branch || 'main' }}
          path: 'clone'

      - name: Replace image URLs in daily notes
        run: |
          echo "å¼€å§‹æ›¿æ¢ clone/daily/ ç›®å½•ä¸‹çš„ Markdown æ–‡ä»¶å†…å®¹..."
          if [ -n "${{ vars.IMAGE_PROXY_URL }}" ]; then
            echo "ä½¿ç”¨çš„ä»£ç†å‰ç¼€: ${{ vars.IMAGE_PROXY_URL }}"
            find clone/daily -type f -name "*.md" -exec sed -i \
              -e 's|upload.chinaz.com|pic.chinaz.com|g' \
              -e 's|https://pic.chinaz.com|${{ vars.IMAGE_PROXY_URL }}&|g' \
              -e 's|https://tvax[12].sinaimg.cn|${{ vars.FOLO_IMAGE_PROXY_URL }}&|g' {} +
            echo "URL æ›¿æ¢å®Œæˆã€‚"
          else
            echo "è­¦å‘Š: ä»“åº“å˜é‡ IMAGE_PROXY_URL æœªè®¾ç½®ï¼Œè·³è¿‡ URL æ›¿æ¢ã€‚"
          fi

      - name: Remove advertisement sections (å¼ºåŠ›ç‰ˆ)
        run: |
          echo "=========================================="
          echo "å¼€å§‹åˆ é™¤å¹¿å‘Šå†…å®¹ï¼ˆå¼ºåŠ›æ¨¡å¼ï¼‰..."
          echo "=========================================="
          
          if [ ! -d "clone/daily" ]; then
            echo "é”™è¯¯: clone/daily ç›®å½•ä¸å­˜åœ¨"
            exit 0
          fi
          
          file_count=0
          processed_count=0
          
          # éå†æ‰€æœ‰ markdown æ–‡ä»¶
          for file in clone/daily/*.md; do
            if [ -f "$file" ]; then
              file_count=$((file_count + 1))
              filename=$(basename "$file")
              echo "æ­£åœ¨å¤„ç†: $filename"
              
              # åˆ›å»ºä¸´æ—¶æ–‡ä»¶
              temp_file="${file}.tmp"
              
              # ä½¿ç”¨ awk åˆ é™¤ä»å¹¿å‘Šæ ‡é¢˜åˆ°æ–‡ä»¶æœ«å°¾çš„æ‰€æœ‰å†…å®¹
              awk '
                /^##[[:space:]]*(ğŸ“»[[:space:]]*)?å°å®‡å®™/ { exit }
                /^##[[:space:]]*(ğŸ“±[[:space:]]*)?æŠ–éŸ³/ { exit }
                /æ¥ç”Ÿå°é…’é¦†/ { exit }
                /è‡ªåª’ä½“è´¦å·/ { exit }
                { print }
              ' "$file" > "$temp_file"
              
              # æ£€æŸ¥æ˜¯å¦æœ‰å®é™…ä¿®æ”¹
              if ! cmp -s "$file" "$temp_file"; then
                mv "$temp_file" "$file"
                processed_count=$((processed_count + 1))
                echo "  âœ“ å·²åˆ é™¤å¹¿å‘Šå†…å®¹"
              else
                rm "$temp_file"
                echo "  - æœªå‘ç°å¹¿å‘Šå†…å®¹"
              fi
            fi
          done
          
          echo "=========================================="
          echo "åˆ é™¤å®Œæˆï¼å…±å¤„ç† $file_count ä¸ªæ–‡ä»¶ï¼Œå…¶ä¸­ $processed_count ä¸ªåŒ…å«å¹¿å‘Š"
          echo "=========================================="

      - name: Process, Archive, and Update Content
        run: |
          #!/bin/bash
          set -e
          export LANG=C.UTF-8

          SOURCE_DIR="clone/daily"
          TARGET_CONTENT_DIR="content/cn"

          echo "--- æ­¥éª¤ 0.1: è¯»å–é»˜è®¤æè¿°ä¿¡æ¯ ---"
          DEFAULT_DESCRIPTION=""
          if [ -f "hugo.yaml" ]; then
            DEFAULT_DESCRIPTION=$(yq e '.params.description' -N hugo.yaml || true)
            if [ -n "$DEFAULT_DESCRIPTION" ]; then
              echo "ä» hugo.yaml ä¸­è¯»å–åˆ°é»˜è®¤ description: $DEFAULT_DESCRIPTION"
            else
              echo "è­¦å‘Š: åœ¨ hugo.yaml ä¸­æœªæ‰¾åˆ° .params.description æˆ–å…¶å€¼ä¸ºç©ºã€‚"
              DEFAULT_DESCRIPTION="æŸ¥çœ‹è¯¦æƒ…"
            fi
          else
            echo "è­¦å‘Š: hugo.yaml æ–‡ä»¶æœªæ‰¾åˆ°ï¼Œæ— æ³•è¯»å–é»˜è®¤ descriptionã€‚"
            DEFAULT_DESCRIPTION="æŸ¥çœ‹è¯¦æƒ…"
          fi

          echo "--- æ­¥éª¤ 0.2: è¯»å–é»˜è®¤å­æ ‡é¢˜ ---"
          DEFAULT_SUBTITLE=""
          if [ -f "hugo.yaml" ]; then
            DEFAULT_SUBTITLE=$(yq e '.params.subTitle' -N hugo.yaml || true)
            if [ -n "$DEFAULT_SUBTITLE" ]; then
              echo "ä» hugo.yaml ä¸­è¯»å–åˆ°é»˜è®¤ subTitle: $DEFAULT_SUBTITLE"
            fi
          fi

          echo "--- æ­¥éª¤ 1: è¯†åˆ«æ–‡ä»¶å¹¶æå–å…³é”®ä¿¡æ¯ ---"
          if [ ! -d "$SOURCE_DIR" ] || [ -z "$(ls -A $SOURCE_DIR)" ]; then
            echo "æºç›®å½• $SOURCE_DIR ä¸å­˜åœ¨æˆ–ä¸ºç©ºï¼Œé€€å‡ºã€‚"
            exit 0
          fi

          ALL_NOTES=$(find "$SOURCE_DIR" -maxdepth 1 -type f -name "????-??-??.md" | sort -r)

          if [ -z "$ALL_NOTES" ]; then
            echo "åœ¨ $SOURCE_DIR ä¸­æœªæ‰¾åˆ°ä»»ä½•æ—¥åˆŠæ–‡ä»¶ï¼Œé€€å‡ºã€‚"
            exit 0
          fi

          LATEST_NOTE=$(echo "$ALL_NOTES" | head -n 1)
          SECOND_LATEST_NOTE=$(echo "$ALL_NOTES" | head -n 2 | tail -n 1)
          ARCHIVE_NOTES=$(echo "$ALL_NOTES" | tail -n +1)

          echo "æœ€æ–°æ–‡ä»¶ (ç”¨äºä¸»é¡µ): $(basename $LATEST_NOTE)"
          
          LATEST_DESCRIPTION=$(echo "$DEFAULT_DESCRIPTION" | sed 's/"/\\"/g')
          echo "å·²æå–å¹¶ä¿å­˜ description: $LATEST_DESCRIPTION"

          echo "--- æ­¥éª¤ 2: å½’æ¡£æ–‡ä»¶åˆ°å¹´æœˆç›®å½• ---"
          if [ -z "$ARCHIVE_NOTES" ]; then
            echo "æ²¡æœ‰éœ€è¦å½’æ¡£çš„æ–‡ä»¶ï¼Œè·³è¿‡ã€‚"
          else
            echo "$ARCHIVE_NOTES" | while read -r source_file; do
              if [ -z "$source_file" ]; then continue; fi
              
              filename=$(basename "$source_file")
              YEAR_MONTH=$(echo "$filename" | cut -c 1-7)
              TARGET_FILE="$TARGET_CONTENT_DIR/$YEAR_MONTH/$filename"

              if [ -f "$TARGET_FILE" ]; then
                 echo "æ–‡ä»¶ $TARGET_FILE å·²å­˜åœ¨ï¼Œå‡è®¾å†…å®¹æœªå˜ï¼Œè·³è¿‡å½’æ¡£å¤„ç†ã€‚"
              fi

              echo "æ­£åœ¨å¤„ç†å½’æ¡£: $filename"
              YEAR=$(echo "$filename" | cut -c 1-4)
              MONTH=$(echo "$filename" | cut -c 6-7)
              DAY=$(echo "$filename" | cut -c 9-10)
              DAY_NO_ZERO=$(echo $DAY | sed 's/^0*//')
              TARGET_MONTH_DIR="$TARGET_CONTENT_DIR/$YEAR_MONTH"

              if [ ! -d "$TARGET_MONTH_DIR" ]; then
                mkdir -p "$TARGET_MONTH_DIR"
                year_month_num_str="${YEAR}${MONTH}"
                year_month_num=$(printf "%d" "$year_month_num_str")
                index_weight=$((300000 - year_month_num))
                printf -- "---\ntitle: %s-%s\nweight: %d\nbreadcrumbs: false\nsidebar:\n  open: true\n---\n" \
                "$YEAR" "$MONTH" "$index_weight" > "$TARGET_MONTH_DIR/_index.md"
                echo "åˆ›å»ºäº†æœˆåº¦ç´¢å¼•: $TARGET_MONTH_DIR/_index.md"
              fi

              weight=$((32 - DAY_NO_ZERO))
              
              local_description=""
              if grep -q "AIå†…å®¹æ‘˜è¦" "$source_file"; then
                local_description=$(grep -A 5 "AIå†…å®¹æ‘˜è¦" "$source_file" | sed -n '/AIå†…å®¹æ‘˜è¦/!p' | sed 's/^[#* >]*//g' | python3 -c 'import sys; print(sys.stdin.read().replace("\n", " ").replace("```", "").strip()[:150])')
              elif grep -q "AIäº§å“ä¸åŠŸèƒ½æ›´æ–°" "$source_file"; then
                local_description=$(grep -A 5 "AIäº§å“ä¸åŠŸèƒ½æ›´æ–°" "$source_file" | sed -n '/AIäº§å“ä¸åŠŸèƒ½æ›´æ–°/!p' | sed 's/^[#* >]*//g' | python3 -c 'import sys; print(sys.stdin.read().replace("\n", " ").replace("```", "").strip()[:150])')
              else
                echo "è­¦å‘Š: æ–‡ä»¶ '$source_file' ä¸­æœªæ‰¾åˆ°æ‘˜è¦ã€‚å°†ä½¿ç”¨ hugo.yaml ä¸­çš„é»˜è®¤ descriptionã€‚"
                local_description="$DEFAULT_DESCRIPTION"
              fi
              local_description=$(echo "$local_description" | python3 -c 'import sys; text = sys.stdin.read(); print(text.replace("\"", "\\\""))')

              (
                printf -- "---\nlinkTitle: %s-%s-æ—¥æŠ¥\ntitle: %s-%s-æ—¥æŠ¥-AIèµ„è®¯æ—¥æŠ¥\nweight: %d\nbreadcrumbs: false\ncomments: true\ndescription: \"%s\"\n---\n\n" \
                  "$MONTH" "$DAY" "$MONTH" "$DAY" "$weight" "$local_description"
                cat "$source_file"
              ) > "$TARGET_FILE"
              echo "å·²å½’æ¡£åˆ° $TARGET_FILE (æˆ–å·²æ›´æ–°)"
            done
          fi

          echo "--- æ­¥éª¤ 3: æ›´æ–°ä¸Šä¸ªæœˆä¾§è¾¹æ çŠ¶æ€ ---"
          LATEST_NOTE_MONTH=$(basename "$LATEST_NOTE" .md | cut -c 1-7)

          if [[ "$LATEST_NOTE_MONTH" =~ ^[0-9]{4}-[0-9]{2}$ ]]; then
            PREVIOUS_TO_LATEST_MONTH=$(date -d "$LATEST_NOTE_MONTH-01 -1 month" +"%Y-%m")
            PREVIOUS_INDEX_FILE="$TARGET_CONTENT_DIR/$PREVIOUS_TO_LATEST_MONTH/_index.md"
            
            if [ -f "$PREVIOUS_INDEX_FILE" ] && grep -q "open: true" "$PREVIOUS_INDEX_FILE"; then
              sed -i 's/open: true/open: false/g' "$PREVIOUS_INDEX_FILE"
              echo "å·²æ›´æ–° $PREVIOUS_INDEX_FILEï¼Œè®¾ç½® sidebar open ä¸º falseã€‚"
            elif [ -f "$PREVIOUS_INDEX_FILE" ]; then
              echo "$PREVIOUS_INDEX_FILE ä¾§è¾¹æ å·²ä¸º open: false æˆ–æœªè®¾ç½®ï¼Œæ— éœ€æ“ä½œã€‚"
            else
              echo "ä¸Šä¸Šä¸ªæœˆçš„ç´¢å¼•æ–‡ä»¶ $PREVIOUS_INDEX_FILE æœªæ‰¾åˆ°ï¼Œè·³è¿‡ä¾§è¾¹æ æŠ˜å ã€‚"
            fi

            LATEST_MONTH_INDEX_FILE="$TARGET_CONTENT_DIR/$LATEST_NOTE_MONTH/_index.md"
            if [ -f "$LATEST_MONTH_INDEX_FILE" ] && grep -q "open: false" "$LATEST_MONTH_INDEX_FILE"; then
                sed -i 's/open: false/open: true/g' "$LATEST_MONTH_INDEX_FILE"
                echo "å·²ç¡®ä¿ $LATEST_MONTH_INDEX_FILE çš„ä¾§è¾¹æ ä¸º open: trueã€‚"
            elif [ -f "$LATEST_MONTH_INDEX_FILE" ] && ! grep -q "open: true" "$LATEST_MONTH_INDEX_FILE"; then
                 if grep -q "sidebar:" "$LATEST_MONTH_INDEX_FILE"; then
                    sed -i '/sidebar:/a\ \ open: true' "$LATEST_MONTH_INDEX_FILE"
                    sed -i 's/open: .*/open: true/' "$LATEST_MONTH_INDEX_FILE"
                    echo "å·²å°è¯•æ›´æ–°/æ·»åŠ  $LATEST_MONTH_INDEX_FILE çš„ä¾§è¾¹æ ä¸º open: trueã€‚"
                 fi
            elif [ -f "$LATEST_MONTH_INDEX_FILE" ]; then
                echo "$LATEST_MONTH_INDEX_FILE ä¾§è¾¹æ å·²ä¸º open: trueï¼Œæ— éœ€æ“ä½œã€‚"
            fi
          else
            echo "æ— æ³•ä» $LATEST_NOTE è§£ææœˆä»½ï¼Œè·³è¿‡ä¾§è¾¹æ æŠ˜å é€»è¾‘ã€‚"
          fi

          echo "--- æ­¥éª¤ 4: æ›´æ–°ä¸»ç´¢å¼•é¡µé¢ (content/cn/_index.md) ---"
          TARGET_INDEX="$TARGET_CONTENT_DIR/_index.md"
          
          FRONTMATTER="---\nlinkTitle: AI Daily\ntitle: AI Daily-AIèµ„è®¯æ—¥æŠ¥\nbreadcrumbs: false\n"
          if [ -n "$SECOND_LATEST_NOTE" ] && [ "$LATEST_NOTE" != "$SECOND_LATEST_NOTE" ]; then
            FILENAME_SECOND_LATEST=$(basename "$SECOND_LATEST_NOTE" .md)
            YEAR_MONTH_SECOND_LATEST=$(echo "$FILENAME_SECOND_LATEST" | cut -c 1-7)
            NEXT_LINK="${YEAR_MONTH_SECOND_LATEST}/${FILENAME_SECOND_LATEST}"
            FRONTMATTER+="next: /${NEXT_LINK}\n"
          fi
          
          FRONTMATTER+="description: \"${LATEST_DESCRIPTION}\"\n"
          FRONTMATTER+="cascade:\n  type: docs\n---\n\n"

          printf "%b" "$FRONTMATTER" > "$TARGET_INDEX"
          cat "$LATEST_NOTE" >> "$TARGET_INDEX"
          echo "$TARGET_INDEX æ›´æ–°å®Œæˆã€‚"

      - name: Commit and push changes
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "chore(content): è‡ªåŠ¨åŒæ­¥æ¯æ—¥æ–‡ç« åŠæ›´æ–°ä¸»é¡µï¼ˆå·²åˆ é™¤å¹¿å‘Šï¼‰"
          file_pattern: 'content/*'
          commit_user_name: "GitHub Actions Bot"
          commit_user_email: "actions@github.com"
